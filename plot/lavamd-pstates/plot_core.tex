\@ifundefined{pstatelavamdtable}{%
  \pgfplotstableread[col sep=comma]{plot/lavamd-pstates/data/pstate_power_4_cores.csv}\pstatelavamdtable
}{}

\begin{tikzpicture}
  \begin{axis}[
    width=0.95\linewidth,
    axis on top,
    axis x line=bottom,
    axis y line=left,
  	xlabel={Runtime \emph{(s)}},
    ylabel={Energy \emph{(J)}},    
    xmin=0, xmax=140,
    ymin=0, ymax=3800,
    legend columns=2,
    legend to name=lavamd-pstate:legend,
    legend style={/tikz/every even column/.append style={column sep=0.2cm}} % space out columns a bit
    ]

    %% Model Parameters %%
    \pgfplotstablegetelem{0}{Runtime}\of{\pstatelavamdtable}
    \pgfmathsetmacro{\codetime}{\pgfplotsretval} 
    \pgfplotstablegetelem{0}{Energy}\of{\pstatelavamdtable}
    \pgfmathsetmacro{\codeenergy}{\pgfplotsretval} 
    \pgfmathsetmacro{\baselinepower}{13.510238}

    %% Intermezzo Values %%
    \pgfmathsetmacro{\codepower}{\codeenergy / \codetime}

    % arguments: code power, code time, x, n 
    \pgfmathdeclarefunction{metricbound}{4}{%
      \pgfmathparse{((#1 * #2^(#4 + 1)) / #3^#4)}%
    }
    \pgfmathdeclarefunction{definitionbound}{4}{%
      \pgfmathparse{((#1 / #2^(#4 + 1)) * #3^(#4 + 2))}%
    }

    % ALPHA BASELINE BOUND 
    \addplot[color=green, name path=basebound, domain=\pgfkeysvalueof{/pgfplots/xmin}:\pgfkeysvalueof{/pgfplots/xmax}] {\baselinepower * x};
    \addlegendentry{$P_{min}$ Energy Bound} 


    %% 3.2 GHz start point
    \pgfmathsetmacro{\brnodex}{87.73374843784023}
    \pgfmathsetmacro{\blnodex}{49.11016716922632}
    \addplot[name path=edpdef, draw=none, domain=\blnodex:\codetime+1, forget plot] {definitionbound(\codepower, \codetime, x, 2)};
    \addplot[name path=edpopt, draw=none, domain=\codetime-1:\brnodex, forget plot] {metricbound(\codepower, \codetime, x, 2)};

    \path[name path=edpspace,
      intersection segments={
        of=edpdef and edpopt,
        sequence=A0 -- B1,
      }
      ]; 
    \addplot[blue!20] fill between[of=edpspace and basebound]; 
    \addlegendentry{3.2 GHz POSE}

    %% PState progression
    \addplot[mark=x, black] table[x=Runtime,y=Energy, trim cells=true] {\pstatelavamdtable}
      node[pos=0.0, pin=left:3.2 GHz]{}
      node[pos=1.0, pin=95:1.6 GHz]{}
      node[pos=0.636, pin={[pin distance=0.15cm] above:2.1 GHz}]{}
    ;
    \addlegendentry{P-State Progression}


    %%
    \pgfmathsetmacro{\codetime}{67.788671}
    \pgfmathsetmacro{\codepower}{30.534496154969613}
    \pgfmathsetmacro{\blnodex}{51.65525781584337}
    \addplot[name path=edpdef, gray, densely dashed, domain=\blnodex:\codetime, forget plot] {definitionbound(\codepower, \codetime, x, 2)};

    %%
    \pgfmathsetmacro{\codetime}{69.909725}
    \pgfmathsetmacro{\codepower}{28.972621505806238}
    \pgfmathsetmacro{\blnodex}{54.21207070239038}
    \addplot[name path=edpdef, gray, densely dashed, domain=\blnodex:\codetime, forget plot] {definitionbound(\codepower, \codetime, x, 2)};

    %%
    \pgfmathsetmacro{\codetime}{72.820343}
    \pgfmathsetmacro{\codepower}{27.23156518227331}
    \pgfmathsetmacro{\blnodex}{57.647815146592066}
    \addplot[name path=edpdef, gray, densely dashed, domain=\blnodex:\codetime, forget plot] {definitionbound(\codepower, \codetime, x, 2)};

    %%
    \pgfmathsetmacro{\codetime}{78.83738}
    \pgfmathsetmacro{\codepower}{24.363863791516156}
    \pgfmathsetmacro{\blnodex}{64.76958711476986}
    \addplot[name path=edpdef, gray, densely dashed, domain=\blnodex:\codetime, forget plot] {definitionbound(\codepower, \codetime, x, 2)};

    %%
    \pgfmathsetmacro{\codetime}{80.443575}
    \pgfmathsetmacro{\codepower}{23.569310575766927}
    \pgfmathsetmacro{\blnodex}{66.82363092159444}
    \addplot[name path=edpdef, gray, densely dashed, domain=\blnodex:\codetime, forget plot] {definitionbound(\codepower, \codetime, x, 2)};

    %%
    \pgfmathsetmacro{\codetime}{83.583275}
    \pgfmathsetmacro{\codepower}{22.42571518045925}
    \pgfmathsetmacro{\blnodex}{70.59245458487962}
    \addplot[name path=edpdef, gray, densely dashed, domain=\blnodex:\codetime, forget plot] {definitionbound(\codepower, \codetime, x, 2)};

    %%
    \pgfmathsetmacro{\codetime}{87.25231}
    \pgfmathsetmacro{\codepower}{21.415643975500476}
    \pgfmathsetmacro{\blnodex}{74.83203474018039}
    \addplot[name path=edpdef, gray, densely dashed, domain=\blnodex:\codetime, forget plot] {definitionbound(\codepower, \codetime, x, 2)};

    %%
    \pgfmathsetmacro{\codetime}{90.581583}
    \pgfmathsetmacro{\codepower}{20.54295973167084}
    \pgfmathsetmacro{\blnodex}{78.77224707386881}
    \addplot[name path=edpdef, gray, densely dashed, domain=\blnodex:\codetime, forget plot] {definitionbound(\codepower, \codetime, x, 2)};

    %%
    \pgfmathsetmacro{\codetime}{95.357508}
    \pgfmathsetmacro{\codepower}{19.637888418812288}
    \pgfmathsetmacro{\blnodex}{84.1803958382032}
    \addplot[name path=edpdef, gray, densely dashed, domain=\blnodex:\codetime, forget plot] {definitionbound(\codepower, \codetime, x, 2)};

    %%
    \pgfmathsetmacro{\codetime}{99.502899}
    \pgfmathsetmacro{\codepower}{18.820670933416725}
    \pgfmathsetmacro{\blnodex}{89.0932975465577}
    \addplot[name path=edpdef, red, densely dashed, domain=\blnodex:\codetime] {definitionbound(\codepower, \codetime, x, 2)};
    \addlegendentry{Optimisation Cutoff}
    %%
    \pgfmathsetmacro{\codetime}{109.970804}
    \pgfmathsetmacro{\codepower}{17.334285425429826}
    \pgfmathsetmacro{\blnodex}{101.20370662532102}
    \addplot[name path=edpdef, gray, densely dashed, domain=\blnodex:\codetime, forget plot] {definitionbound(\codepower, \codetime, x, 2)};

    %%
    \pgfmathsetmacro{\codetime}{115.469869}
    \pgfmathsetmacro{\codepower}{16.703561489274747}
    \pgfmathsetmacro{\blnodex}{107.58539357794623}
    \addplot[name path=edpdef, gray, densely dashed, domain=\blnodex:\codetime, forget plot] {definitionbound(\codepower, \codetime, x, 2)};

    %%
    \pgfmathsetmacro{\codetime}{123.182269}
    \pgfmathsetmacro{\codepower}{16.060352379123653}
    \pgfmathsetmacro{\blnodex}{116.28334319474206}
    \addplot[name path=edpdef, gray, densely dashed, domain=\blnodex:\codetime, forget plot] {definitionbound(\codepower, \codetime, x, 2)};

    %%
    \pgfmathsetmacro{\codetime}{130.924339}
    \pgfmathsetmacro{\codepower}{15.486518591474423}
    \pgfmathsetmacro{\blnodex}{125.09985043035239}
    \addplot[name path=edpdef, gray, densely dashed, domain=\blnodex:\codetime, forget plot] {definitionbound(\codepower, \codetime, x, 2)};
  \end{axis}
\end{tikzpicture}
